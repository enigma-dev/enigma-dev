# competition for Thundercleese
notifications:
  irc: "chat.freenode.net#enigma"
# disable the depth option for git allowing us to merge multiple prs simultaneously
git:
  depth: false
# don't build "feature" branches
branches:
  only:
    - "master"
    
# by default most of our jobs will be run on a linux instance
os: linux
group: travis_latest
compiler: gcc
language: cpp
dist: bionic

env:
  global:
    - OUTPUT=/tmp/test
    # this is the default config each job in the matrix overrides a subset of
    - COMPILER=gcc PLATFORM=xlib MODE=Debug GRAPHICS=OpenGL1 AUDIO=None COLLISION=None NETWORK=None WIDGETS=None EXTENSIONS="None"

cache:
  directories:
  - emake
  - libcompileEGMf.so
  - libEGM.so
  - libProtocols.so
  - /tmp/ENIGMA

before_install:
  - sudo dpkg --add-architecture i386;
  - sudo add-apt-repository -y ppa:maarten-fonville/protobuf;
  - sudo apt-get update --option Acquire::Retries=100 --option Acquire::http::Timeout="60";

install: ./CI/install_engine_deps.sh

script: ./CI/build_and_run_game.sh
    
jobs:
  # don't wait for OSX
  fast_finish: true
  allow_failures:
    - os: osx
  include:
    - stage: emake
      install: ./CI/install_emake_deps.sh
      script: make -j4 && make -j4 emake
    - stage: Test Harness and platforms # xlib is covered by default
      env: TEST_HARNESS=true AUDIO=OpenAL
    - stage: Test Harness and platforms
      env: PLATFORM=None GRAPHICS=None AUDIO=None COLLISION=None NETWORK=None WIDGETS=None EXTENSIONS="None"
    - stage: Test Harness and platforms
      env: PLATFORM=SDL GRAPHICS=OpenGL1
    - stage: Test Harness and platforms
      env: PLATFORM=SDL GRAPHICS=OpenGL3
    - stage: Graphics Systems # test graphics specific extensions here
      env: GRAPHICS=OpenGL1 EXTENSIONS="ParticleSystems"
    - stage: Graphics Systems
      env: GRAPHICS=OpenGL3 EXTENSIONS="ParticleSystems"
    - stage: Graphics Systems
      env: GRAPHICS=OpenGLES2 PLATFORM=SDL EXTENSIONS="ParticleSystems"
    - stage: Audio Systems # test audio specific extensions here
      env: AUDIO=OpenAL EXTENSIONS="GME"
    - stage: Audio Systems
      env: AUDIO=SFML EXTENSIONS="GME"
    - stage: Collision Systems
      env: COLLISION=BBox NETWORK=None EXTENSIONS="Paths,MotionPlanning"
    - stage: Collision Systems
      env: COLLISION=Precise NETWORK=None EXTENSIONS="Paths,MotionPlanning"
    - stage: Networking Systems
      env: NETWORK=Asynchronous
    - stage: Networking Systems
      env: NETWORK=BerkeleySockets
    - stage: Widget Systems
      env: WIDGETS=GTK+
    - stage: Widget Systems
      env: WIDGETS=Zenity
    - stage: Widget Systems
      env: WIDGETS=KDialog
    - stage: Extensions # test all xlib compatible extensions here
      env: COLLISION=BBox EXTENSIONS="Alarms,Timelines,DataStructures,Asynchronous,BasicGUI,DataStructures,DateTime,GM5Compat,IniFilesystem,DataStructures,Json,XRandR,Paths,MotionPlanning,GME,ttf,Box2DPhysics,StudioPhysics,BulletDynamics"
    - stage: Cross Compile # test platform specfic stuff here
      env: COMPILER=MinGW32 PLATFORM=Win32 Widgets=Win32 AUDIO=DirectSound EXTENSIONS="DirectShow,WindowsTouch,XInput,MediaControlInterface,FileDropper,IniFileSystem"
    - stage: Cross Compile 
      env: COMPILER=MinGW64 PLATFORM=Win32 Widgets=Win32 AUDIO=DirectSound EXTENSIONS="DirectShow,WindowsTouch,XInput,MediaControlInterface,FileDropper,IniFileSystem"
    - stage: Cross Compile 
      env: COMPILER=gcc32
    - stage: Cross Compile 
      env: COMPILER=clang
    - stage: Cross Compile 
      env: COMPILER=clang32
    - stage: Mac OSX
      os: osx
      osx_image: xcode9.2
      env: COMPILER=clang PLATFORM=None
    - stage: Mac OSX
      os: osx
      osx_image: xcode9.2
      env: COMPILER=clang PLATFORM=None

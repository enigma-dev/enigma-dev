# Awesomer Makefile generated by Rusky: stop relying on Bash hacks and automate more stuff
# It will automatically build the shared library out of any .cpp files in this directory or its
# subdirectories (recursively). It will also automatically calculate and update all dependencies
# automatically when 'make' is run, so there is no need to run genmake.sh EVER.

#################
# configuration #
#################
# TODO: better config process based on features rather than OS

BASE = compileEGMf
OS := $(shell uname -s)
ifeq ($(OS), Linux)
	TARGET := ../lib$(BASE).so
	CXXFLAGS += -fPIC
else ifeq ($(OS), Darwin)
	TARGET := ../lib$(BASE).dylib
	CXXFLAGS += -fPIC
else
	TARGET := ../$(BASE).dll
	LDFLAGS += -static-libstdc++ -static-libgcc
endif

###########
# options #
###########

CXX := g++
CXXFLAGS += -Wall -s -O3
LDFLAGS += -shared

SOURCES := $(shell find -name '*.cpp' -and ! -name 'standalone_*')
OBJECTS := $(addprefix .eobjs/,$(SOURCES:.cpp=.o))
DEPENDS := $(OBJECTS:.o=.d)

# sort has the nice side effect of removing duplicates. this may or may not be faster.
OBJDIRS := $(sort $(dir $(OBJECTS)))

############
# building #
############

.PHONY: all clean

all: $(TARGET)

clean:
	$(RM) $(TARGET) $(OBJECTS) $(DEPENDS)

$(TARGET): $(OBJECTS)
	$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(LDLIBS)

# GCC will figure out dependencies and write out makefile rules in %.d when they change
# -MMD outputs dependencies to %.d as a side effect of compilation, ignoring system headers
# -MP gives phony rules for non-target files, avoiding problems with missing files
.eobjs/%.o .eobjs/%.d: %.cpp | $(OBJDIRS)
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -MMD -MP -c -o .eobjs/$*.o $<

$(OBJDIRS):
	mkdir -p $@

ifneq ($(MAKECMDGOALS),clean)
-include $(DEPENDS)
endif

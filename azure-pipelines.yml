resources:
  repositories:
    - repository: radialgm
      type: github
      name: enigma-dev/RadialGM
      endpoint: github.com_EnigmaBot
      # ref: refs/pull/106/merge # Use this for testing a co-dependent rgm pr but comment this before merging 
      
pr:  # Trigger a build on every PR.
  branches:
    include:
      - '*'  # Must quote since "*" is a YAML reserved character
variables:
- template: azure-vars.yml@radialgm
- group: Test Harness Auth

jobs:
- template: azure-jobs.yml@radialgm
  parameters:
    repo: radialgm
    enigmaref: $(Build.SourceBranch)

- job: TestHarness
  displayName: 'Test Harness'
  variables:
    TEST_HARNESS: "true"
    TRAVIS_OS_NAME: "linux"
    TRAVIS: "true"
    env:
      imgur_client_id: $(imgur_client_id)
      bot_comment_token: $(bot_comment_token)
      bot_push_on_green_token: $(bot_push_on_green_token)
  pool:
    vmImage: 'ubuntu-latest'
  timeoutInMinutes: 360

  steps:
    - checkout: self
      persistCredentials: true
      
    - script: |
        sudo dpkg --add-architecture i386
        ./CI/install_emake_deps.sh
        ./CI/split_jobs.sh install
        ./CI/build_sdl.sh
      displayName: Install Dependencies
      
    - script: |
        make -j4
        make -j4 emake
      displayName: Build emake
      
    - script: |
        make emake-tests
        ./emake-tests
      displayName: Test emake
      
    - script: |
        ./CI/build_and_run_game.sh
      displayName: Run Test Harness
